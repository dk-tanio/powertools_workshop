# Lambda Powertoolsに関するワークショップを作った

# Lambda Powertools ワークショップ資料

## 目的

このリポジトリは、AWS Lambda Powertools を使った実践的な開発体験を通じて、
ロギング、ルーティング、入力検証、例外処理、出力検証の基本を身に付けることを目的とします。

## このワークで得られるもの

- 構造化ログの設計と実装の考え方
- API Gateway + Lambda のルーティング実装の流れ
- Pydantic によるリクエスト検証とレスポンス検証
- 例外の設計とハンドラでの安全な復元
- ドメイン層とインフラ層を分離した構成の読み方

## 利用ライブラリのバージョン

- Python 3.14.1
  - aws-lambda-powertools 3.23.0
  - boto3 1.42.16
  - boto3-stubs 1.42.16
  - pydantic 2.12.5
  - pytest 9.0.2
  - ruff 0.14.10

## 事前準備

mise/uv で簡単に環境構築が可能です。

```bash
mise install
mise trust
```

依存関係の導入は次の手順を推奨します。

```bash
uv sync
```

## AWS 環境にデプロイしたい場合

`infra/` 配下は CDK による AWS へのデプロイ用です。任意でご自身の環境にデプロイしてください。なお APIGateway に認証は入っていません。リソースは自己責任で構築ください。

参考コマンド:

```bash
cd infra
npm install
npx cdk deploy
```

## ブランチ構成と進め方

以下の順で進めます。各ブランチは配布用と解答用に分かれています。

1. `logger/question`（配布用の初期コード）
2. `logger/sample`（ロギングの解答例）
3. `routing/sample`（ルーティングの解答例）
4. `requestBody/sample`（リクエスト検証の解答例）
5. `exception/sample`（例外ルーティングの解答例）
6. `response/sample`（レスポンス検証の解答例）

## ワーク内容

### 1. Logger ワーク

**ゴール**

- 重要なイベントを構造化ログとして記録できるようにする。

**参加者が行うこと**

- 書籍作成時に、書籍識別子などの情報を構造化してログに出す。
- 例外時のログに、失敗した操作や識別子を付与する。

**確認ポイント**

- ログ出力が情報不足になっていないか。
- 例外時のログが調査に使える粒度になっているか。

### 2. Routing ワーク

**ゴール**

- API Gateway のパスに応じて適切なハンドラ関数へルーティングできるようにする。

**参加者が行うこと**

- 書籍の一覧取得、作成、単体取得、更新、削除のエンドポイントを定義する。
- ルーティング先でサービス層を呼び出す。

**確認ポイント**

- パスとメソッドの組合せが仕様どおりに動くか。
- パスパラメータの受け渡しが正しいか。

### 3. Request Body ワーク

**ゴール**

- Pydantic によるリクエスト本文の検証ができるようにする。

**参加者が行うこと**

- リクエスト本文のスキーマを定義する。
- ハンドラ関数の引数にスキーマ型を指定し、入力検証を有効化する。

**確認ポイント**

- 必須項目の欠落や型の不一致が検知されるか。
- 値オブジェクトの制約が正しく適用されているか。

### 4. Exception ワーク

**ゴール**

- ドメイン例外を API のレスポンスに変換できるようにする。

**参加者が行うこと**

- ドメイン例外ごとにレスポンスを定義する。
- 例外ハンドラを登録し、適切なステータスコードを返す。

**確認ポイント**

- 書籍が存在しない場合や重複する場合に正しい応答になるか。
- 例外時のログが適切に記録されるか。

### 5. Response ワーク

**ゴール**

- Pydantic を使ってレスポンス内容の整合性を担保できるようにする。

**参加者が行うこと**

- ハンドラの戻り値をモデル型に統一する。
- レスポンスの検証が行われる構成にする。

**確認ポイント**

- 返却するデータがスキーマと一致しているか。
- シリアライズ形式が期待どおりか。

## Powertools の要点

- Logger: 構造化ログの出力やコンテキスト追加が簡潔にできる。
- Event Handler: API Gateway のルーティングやバリデーションを簡潔にできる。
- 型注釈との相性が良く、Pydantic と組み合わせると検証が強固になる。

## 参考ディレクトリ構成

- `src/handler.py` : Lambda エントリポイントとルーティング
- `src/schema.py` : リクエスト本文スキーマ
- `src/domain/` : ドメインモデルと例外
- `src/infrastructure/` : DynamoDB へのアクセス
- `infra/` : CDK による AWS デプロイ（任意）
